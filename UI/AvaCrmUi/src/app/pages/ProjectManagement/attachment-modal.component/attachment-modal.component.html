<div class="modal-backdrop" (click)="closeModal()">
  <div class="modal-content attachment-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-paperclip"></i>
        مدیریت فایل‌های تسک: {{ taskTitle }}
      </h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- بخش آپلود فایل -->
      <div class="upload-section">
        <h4>آپلود فایل جدید</h4>
        <div class="upload-form">
          <div class="form-group">
            <label for="fileInput" class="form-label">انتخاب فایل *</label>
            <input
              type="file"
              id="fileInput"
              (change)="onFileSelected($event)"
              class="form-control"
              accept="*/*">
            <small class="form-text">حداکثر حجم: 10MB</small>
          </div>

          <div class="form-group">
            <label for="fileName" class="form-label">نام نمایشی فایل *</label>
            <input
              type="text"
              id="fileName"
              [(ngModel)]="downloadedFileName"
              placeholder="نامی که کاربر می‌بیند (الزامی)"
              class="form-control"
              [class.is-invalid]="!downloadedFileName.trim()">
            <div class="error-message" *ngIf="!downloadedFileName.trim()">
              نام نمایشی فایل الزامی است
            </div>
          </div>

          <div class="upload-actions">
            <button
              class="btn btn-primary upload-btn"
              (click)="uploadFile()"
              [disabled]="!selectedFile || !downloadedFileName.trim() || uploading">
              <i class="fas fa-upload" *ngIf="!uploading"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="uploading"></i>
              {{ uploading ? 'در حال آپلود...' : 'آپلود فایل' }}
            </button>

            <div class="progress-container" *ngIf="uploading">
              <div class="progress">
                <div
                  class="progress-bar"
                  [style.width]="uploadProgress + '%'"
                  role="progressbar"
                  [attr.aria-valuenow]="uploadProgress"
                  aria-valuemin="0"
                  aria-valuemax="100">
                  {{ uploadProgress }}%
                </div>
              </div>
            </div>

            <div class="selected-file" *ngIf="selectedFile">
              <i class="fas fa-file"></i>
              فایل انتخاب شده: {{ selectedFile.name }} ({{ getFileSize(selectedFile.size) }})
            </div>
          </div>
        </div>
      </div>

      <!-- لیست فایل‌ها -->
      <div class="attachments-section">
        <h4>فایل‌های آپلود شده ({{ attachments.length }})</h4>

        <div class="attachments-list" *ngIf="!loading; else loadingTemplate">
          <div class="no-attachments" *ngIf="attachments.length === 0">
            <i class="fas fa-folder-open"></i>
            <p>هیچ فایلی آپلود نشده است</p>
          </div>

          <div class="attachment-item" *ngFor="let attachment of attachments">
            <div class="attachment-icon">
              <i [class]="getFileIcon(attachment.fileName)"></i>
            </div>

            <div class="attachment-info">
              <div class="attachment-name">{{ attachment.downloadedFileName }}</div>
              <div class="attachment-meta">
                <span class="file-name">
                  <i class="fas fa-hashtag"></i>
                  {{ getFileNameFromPath(attachment.fileName) }}
                </span>
              </div>
            </div>

            <div class="attachment-actions">
              <!-- دکمه پیش‌نمایش (فقط برای فایل‌های قابل نمایش) -->
              <button
                class="btn btn-sm btn-info"
                (click)="previewAttachment(attachment)"
                [disabled]="!isPreviewable(attachment.fileName)"
                title="پیش‌نمایش"
                *ngIf="isPreviewable(attachment.fileName)">
                <i class="fas fa-eye"></i>
              </button>

              <button
                class="btn btn-sm btn-success"
                (click)="downloadAttachment(attachment)"
                title="دانلود">
                <i class="fas fa-download"></i>
              </button>

              <button
                class="btn btn-sm btn-danger"
                (click)="deleteAttachment(attachment)"
                title="حذف">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal پیش‌نمایش فایل -->
<div class="preview-backdrop" *ngIf="selectedAttachment" (click)="closePreview()">
  <div class="preview-modal" (click)="$event.stopPropagation()">
    <div class="preview-header">
      <h4>
        <i [class]="getFileIcon(selectedAttachment.fileName)"></i>
        پیش‌نمایش: {{ selectedAttachment.downloadedFileName }}
      </h4>
      <div class="preview-actions">
        <button class="btn btn-sm btn-success" (click)="downloadAttachment(selectedAttachment)">
          <i class="fas fa-download"></i>
          دانلود
        </button>
        <button class="btn btn-sm btn-danger" (click)="deleteAttachment(selectedAttachment)">
          <i class="fas fa-trash"></i>
          حذف
        </button>
        <button class="btn btn-sm btn-secondary" (click)="closePreview()">
          <i class="fas fa-times"></i>
          بستن
        </button>
      </div>
    </div>

    <div class="preview-content">
      <div class="preview-loading" *ngIf="!previewUrl">
        <i class="fas fa-spinner fa-spin"></i>
        <span>در حال بارگذاری پیش‌نمایش...</span>
      </div>

      <div class="preview-container" *ngIf="previewUrl">
        <!-- پیش‌نمایش تصاویر -->
        <img
          *ngIf="previewType === 'image'"
          [src]="previewUrl"
          [alt]="selectedAttachment.downloadedFileName"
          class="image-preview">

        <!-- پیش‌نمایش PDF -->
        <iframe
          *ngIf="previewType === 'pdf'"
          [src]="previewUrl"
          class="pdf-preview"
          title="PDF Preview">
          مرورگر شما از نمایش PDF پشتیبانی نمی‌کند.
          <a [href]="previewUrl" target="_blank">برای مشاهده کلیک کنید</a>
        </iframe>

        <!-- پیش‌نمایش متن -->
        <iframe
          *ngIf="previewType === 'text'"
          [src]="previewUrl"
          class="text-preview"
          title="Text Preview">
        </iframe>

        <!-- فایل‌های غیرقابل پیش‌نمایش -->
        <div *ngIf="previewType === 'unsupported'" class="unsupported-preview">
          <i class="fas fa-eye-slash"></i>
          <p>پیش‌نمایش برای این نوع فایل پشتیبانی نمی‌شود</p>
          <button class="btn btn-primary" (click)="downloadAttachment(selectedAttachment)">
            <i class="fas fa-download"></i>
            دانلود فایل
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-attachments">
    <i class="fas fa-spinner fa-spin"></i>
    <span>در حال بارگذاری فایل‌ها...</span>
  </div>
</ng-template>
